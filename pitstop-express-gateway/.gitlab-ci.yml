include:
  - local: '.gitlab-ci-base.yml'
  - template: Jobs/SAST.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/Container-Scanning.gitlab-ci.yml
  - template: DAST.gitlab-ci.yml

variables:
  GITLAB_ADVANCED_SAST_ENABLED: 'true'
  SERVICE_PATH: pitstop-express-gateway
  DOCKER_IMAGE_NAME: pitstop-express-gateway
  ARTIFACTS_PATH: ${SERVICE_PATH}/node_modules/
  SECURITY_JOB: gateway-security-scan
  NODE_ENV: production
  CACHE_KEY: ${CI_COMMIT_REF_SLUG}
  YAML_NAME_1: "gateway.yaml"
  
stages:
  - security
  - test
  - build
  - package
  - deploy-k8s

gemnasium-dependency_scanning:
  rules:
    - when: always

gateway-security-scan:
  extends: .security_scan

container_scanning:
  stage: container-security
  rules:
    - when: always

build-gateway-service:
  stage: build
  image: node:16
  script:
    - cd ${SERVICE_PATH}
    - npm install --production=false
  artifacts:
    paths:
      - ${SERVICE_PATH}/dist/
  cache:
    paths:
      - ${SERVICE_PATH}/node_modules/

package-gateway-service:
  extends: .package
  needs:
    - build-gateway-service

deploy-k8s-gateway-service:
    # extends : .argoCD
    image: bitnami/git:latest
    stage: deploy-k8s
    before_script:
      # - sleep $((${number} * 60))
      - git config --global user.email "zoulatizakaria3@gmail.com"
      - git config --global user.name "Zakaria-Zoulati"
      # - git config --global credential.helper cache

    script:
      - git clone https://gitlab.com/Zakaria-Zoulati/devops_k8s.git
      - cd devops_k8s/pitstop-k8s/
      - cat gateway.yaml
      - COMMIT_HASH=$(echo "$CI_COMMIT_SHA" | cut -c1-8)
      - | 
        sed -i "s|image: $CI_REGISTRY_USER/pitstop-express-gateway\(:.*\)\?|image: $CI_REGISTRY_USER/pitstop-express-gateway:${COMMIT_HASH}|" ${YAML_NAME_1}
      - cat ${YAML_NAME_1}
      - git add ${YAML_NAME_1}
      - git commit -m "microservice manifests versions changes successfully"
      - git remote set-url origin https://oauth2:$ACCESS_TOKEN_REPO@gitlab.com/Zakaria-Zoulati/devops_k8s.git
      - git push origin main  || true  
    needs: ["deploy-k8s-customer-service"]
